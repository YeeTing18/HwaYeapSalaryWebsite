<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intern Salary Voucher</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Use the same styles as main.html for consistency */
        :root {
            --primary: #8B0000;
            --primary-dark: #4B0000;
            --secondary: #A52A2A;
            --accent: #FFD700;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
            --success: #2e7d32;
            --danger: #8B0000;
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 70px;
        }
        body { background-color: #f5f7fb; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: var(--dark-text); }
        #sidebar { position: fixed; top: 0; left: 0; height: 100vh; width: var(--sidebar-width); background: linear-gradient(180deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 3px 0 15px rgba(0,0,0,0.1); z-index: 1000; overflow-y: auto; }
        .sidebar-header { padding: 25px 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.1); white-space: nowrap; overflow: hidden; }
        .sidebar-header h3 { font-weight: 600; margin: 0; font-size: 1.4rem; display: inline-block; }
        .sidebar-header img { width: 40px; height: 40px; margin-right: 10px; display: inline-block; vertical-align: middle; }
        .nav-link { color: rgba(255,255,255,0.8); padding: 15px 20px; margin: 5px 10px; border-radius: 5px; white-space: nowrap; overflow: hidden; }
        .nav-link:hover, .nav-link.active { color: white; background: rgba(255,255,255,0.1); }
        .nav-link i { width: 25px; text-align: center; margin-right: 10px; font-size: 1.2rem; vertical-align: middle; }
        .nav-link span { vertical-align: middle; }
        .toggle-sidebar {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .toggle-sidebar:hover {
            background: var(--secondary);
        }
        
        #content { padding: 20px; margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); }
        .page-header { padding: 20px; background: white; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .voucher-container { background-color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .voucher-header { background: linear-gradient(to right, var(--primary), var(--secondary)); color: white; padding: 20px; text-align: center; position: relative; }
        .voucher-header h2 { font-size: 1.8rem; letter-spacing: 1px; margin-bottom: 5px; }
        .employee-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 25px; background-color: #f5f5f5; border-bottom: 2px dashed #e0e0e0; }
        .info-group { margin-bottom: 10px; }
        .info-label { font-weight: 600; color: #37474f; display: inline-block; width: 120px; }
        .salary-period-selector { display: flex; gap: 10px; margin-top: 15px; justify-content: center; }
        .details-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
        .earnings, .deductions { padding: 25px; }
        .deductions { background-color: #fff8e1; border-left: 1px solid #ffecb3; }
        .section-title { color: var(--primary); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #CD5C5C; font-size: 1.2rem; }
        .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #e0e0e0; }
        .detail-label { color: #455a64; }
        .detail-value { font-weight: 600; color: #263238; }
        .total-row { display: flex; justify-content: space-between; padding: 15px 0; font-size: 1.1rem; font-weight: 700; margin-top: 10px; }
        .gross-total { color: var(--success); border-top: 2px solid #81c784; }
        .deductions-total { color: var(--danger); border-top: 2px solid #CD5C5C; }
        .net-pay { padding: 25px; background-color: #FFF0F0; border-top: 2px solid #FFD6D6; border-bottom: 2px dashed #e0e0e0; }
        .net-pay-row { display: flex; justify-content: space-between; font-size: 1.4rem; font-weight: 700; color: #8B0000; }
        .signature-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 25px; background-color: #f5f5f5; border-top: 2px dashed #e0e0e0; }
        .signature-group { text-align: center; }
        .signature-label { font-weight: 600; color: #455a64; margin-bottom: 10px; }
        .signature-box { height: 80px; border: 1px dashed #bdbdbd; border-radius: 5px; margin: 0 auto; width: 90%; display: flex; align-items: center; justify-content: center; background-color: white; color: #9e9e9e; font-style: italic; }
        @media print { .salary-period-selector, .action-buttons, #sidebar, .btn-group, .save-section { display: none !important; } #content { margin: 0 !important; padding: 0 !important; width: 100% !important; } .voucher-container { box-shadow: none !important; border: 1px solid #000 !important; } .voucher-header { background: white !important; border-bottom: 2px solid #000 !important; } .voucher-header h2 { color: black !important; } .employee-info { background: white !important; border-bottom: 1px solid #000 !important; } .earnings, .deductions { background: white !important; border: 1px solid #000 !important; } .section-title { color: black !important; border-bottom: 1px solid #000 !important; } .detail-row { border-bottom: 1px solid #000 !important; } .total-row { border-top: 2px solid #000 !important; } .gross-total, .deductions-total { color: black !important; } .net-pay { background: white !important; border: 1px solid #000 !important; } .net-pay-row { color: black !important; } .signature-section { background: white !important; border-top: 1px solid #000 !important; } .signature-box { border: 1px solid #000 !important; } body { font-size: 12pt !important; } h1, h2, h3 { font-size: 14pt !important; } .detail-label, .detail-value { font-size: 11pt !important; } .card, .voucher-container, .section-title, .detail-row, .total-row { border-color: #000 !important; } .voucher-header, .btn-primary, .nav-link { background: white !important; } .info-label, .detail-label, .signature-label { color: black !important; } .watermark { display: none !important; } }
        /* Add sidebar collapsed styles */
        body.sidebar-collapsed #sidebar {
            width: var(--sidebar-collapsed-width);
        }
        
        body.sidebar-collapsed #content {
            margin-left: var(--sidebar-collapsed-width);
            width: calc(100% - var(--sidebar-collapsed-width));
        }

        body.sidebar-collapsed .nav-link span {
            display: none;
        }

        body.sidebar-collapsed .sidebar-header h3 {
            display: none;
        }

        body.sidebar-collapsed .sidebar-header img {
            margin-right: 0;
        }

        /* Add transition for smooth animation */
        #sidebar, #content {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <div id="sidebar">
            <div class="sidebar-header">
                <img src="HwaYeapLogo.jpg" alt="Logo">
                <h3>Salary System</h3>
            </div>
            <ul class="nav flex-column mt-4">
                <li class="nav-item">
                    <a class="nav-link" href="main.html">
                        <i class="fas fa-file-invoice-dollar"></i> <span>Employee Salary Voucher</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#">
                        <i class="fas fa-file-invoice-dollar"></i> <span>Intern Salary Voucher</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="employeePage.html">
                        <i class="fas fa-users"></i> <span>Employee Management</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="monthlySalary.html">
                        <i class="fas fa-chart-line"></i> <span>Salary Record</span>
                    </a>
                </li>
                <li class="nav-item mt-4">
                    <a class="nav-link" href="#">
                        <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                    </a>
                </li>
            </ul>
        </div>
        <!-- Main Content -->
        <div id="content">
            <button class="toggle-sidebar">
                <i class="fas fa-bars"></i>
            </button>
            <div class="page-header">
                <h1 class="h3 mb-0">Intern Salary Voucher</h1>
                <p class="mb-0">View and manage intern salary details</p>
            </div>
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>Intern Salary Details</div>
                </div>
                <div class="card-body">
                    <div class="voucher-container">
                        <div class="voucher-header">
                            <h2>INTERNSHIP SALARY VOUCHER 实习生薪金传票</h2>
                            <div class="salary-period-selector">
                                <select class="form-select" id="salaryMonth" style="width: 120px; display: inline-block;">
                                    <option value="">Select Month</option>
                                    <option value="January">January</option>
                                    <option value="February">February</option>
                                    <option value="March">March</option>
                                    <option value="April">April</option>
                                    <option value="May">May</option>
                                    <option value="June">June</option>
                                    <option value="July">July</option>
                                    <option value="August">August</option>
                                    <option value="September">September</option>
                                    <option value="October">October</option>
                                    <option value="November">November</option>
                                    <option value="December">December</option>
                                </select>
                                <input type="number" class="form-control" id="salaryYear" placeholder="Year" style="width: 100px;" min="2000" max="2100">
                                
                                <!-- Add new section for retrieving old data -->
                                <div class="retrieve-old-data" style="display: inline-block; margin-left: 15px; padding-left: 15px; border-left: 1px solid rgba(255,255,255,0.3);">
                                    <span style="color: white; margin-right: 10px;">Retrieve from:</span>
                                    <select class="form-select" id="retrieveMonth" style="width: 120px; display: inline-block;">
                                        <option value="">Select Month</option>
                                        <option value="January">January</option>
                                        <option value="February">February</option>
                                        <option value="March">March</option>
                                        <option value="April">April</option>
                                        <option value="May">May</option>
                                        <option value="June">June</option>
                                        <option value="July">July</option>
                                        <option value="August">August</option>
                                        <option value="September">September</option>
                                        <option value="October">October</option>
                                        <option value="November">November</option>
                                        <option value="December">December</option>
                                    </select>
                                    <input type="number" class="form-control" id="retrieveYear" placeholder="Year" style="width: 100px; display: inline-block;" min="2000" max="2100">
                                    <button class="btn btn-light btn-sm" onclick="retrieveOldData()" style="margin-left: 10px;">
                                        <i class="fas fa-history"></i> Retrieve
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="employee-info">
                            <div class="info-group">
                                <span class="info-label">PAY TO:</span>
                                <select class="form-select" id="employeeSelect" style="width: 200px; display: inline-block;">
                                    <option value="">Select Intern</option>
                                </select>
                            </div>
                            <div class="info-group">
                                <span class="info-label">I/C NO:</span>
                                <span class="info-value" id="icNumber">-</span>
                            </div>
                            <div class="info-group">
                                <span class="info-label">BANK ACC:</span>
                                <span class="info-value" id="bankAccount">-</span>
                            </div>
                        </div>
                        <div class="salary-calculations" style="background-color: #FFF0F0; padding: 15px 25px; border-bottom: 1px solid #FFD6D6;">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="calculation-item">
                                        <div class="calculation-label" style="font-weight: 600; color: var(--primary);">日薪 SALARY PER DAYS</div>
                                        <div class="calculation-formula" style="font-size: 0.9rem; color: #666;">(BASIC/45/4*9)</div>
                                        <div class="calculation-value" id="dailySalary" style="font-weight: 600; color: var(--primary);">RM 0.00</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="calculation-item">
                                        <div class="calculation-label" style="font-weight: 600; color: var(--primary);">时薪 SALARY PER HOURS</div>
                                        <div class="calculation-formula" style="font-size: 0.9rem; color: #666;">(BASIC/45/4)</div>
                                        <div class="calculation-value" id="hourlySalary" style="font-weight: 600; color: var(--primary);">RM 0.00</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="calculation-item">
                                        <div class="calculation-label" style="font-weight: 600; color: var(--primary);">OT-1.5</div>
                                        <div class="calculation-formula" style="font-size: 0.9rem; color: #666;">(Hours*1.5)</div>
                                        <div class="calculation-value" id="ot1_5" style="font-weight: 600; color: var(--primary);">RM 0.00</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="calculation-item">
                                        <div class="calculation-label" style="font-weight: 600; color: var(--primary);">OT-2.0</div>
                                        <div class="calculation-formula" style="font-size: 0.9rem; color: #666;">(Hours*2.0)</div>
                                        <div class="calculation-value" id="ot2_0" style="font-weight: 600; color: var(--primary);">RM 0.00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="earnings">
                                <h3 class="section-title">Earnings</h3>
                                <div class="detail-row">
                                    <span class="detail-label">BASIC PAY 基本支付</span>
                                    <span class="detail-value" id="basicPay">RM 0.00</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">OVERTIME 超时</span>
                                    <div class="overtime-inputs" style="display: flex; gap: 10px; align-items: center;">
                                        <input type="number" class="form-control form-control-sm" id="otHours" style="width: 80px;" min="0" step="0.5" placeholder="Hours">
                                        <select class="form-select form-select-sm" id="otMultiplier" style="width: 100px;">
                                            <option value="1.5">1.5x</option>
                                            <option value="2.0">2.0x</option>
                                        </select>
                                        <button class="btn btn-sm btn-outline-primary" id="addOvertime">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </div>
                                </div>
                                <div id="overtimeList" style="margin-left: 20px; margin-top: 10px;"></div>
                                <div class="detail-row" id="totalOvertimeRow" style="display: none;">
                                    <span class="detail-label">Total Overtime</span>
                                    <span class="detail-value" id="totalOvertime">RM 0.00</span>
                                </div>
                                <div class="total-row gross-total">
                                    <span>(A) GROSS PAY 总付额</span>
                                    <span id="grossPayAmount">RM 0.00</span>
                                </div>
                            </div>
                            <div class="deductions">
                                <h3 class="section-title">Deductions</h3>
                                <div class="detail-row">
                                    <span class="detail-label">ADVANCE / LOAN 预支/贷款</span>
                                    <div class="input-group" style="width: 300px;">
                                        <span class="input-group-text" style="width: 20%;">RM</span>
                                        <input type="number" class="form-control" id="advanceLoan" value="0.00" step="0.01" style="width: 40%;">
                                        <select class="form-select" id="advanceLoanType" style="width: 40%;">
                                            <option value="Cash">Cash</option>
                                            <option value="BankIn">BankIn</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">DAILY DEDUCTION 每日扣除</span>
                                    <div class="input-group input-group-sm" style="width: 200px;">
                                        <span class="input-group-text">RM</span>
                                        <input type="number" class="form-control" id="dailyDeduction" min="0" step="0.01" value="0.00">
                                    </div>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">HOURS DEDUCTION 小时扣除</span>
                                    <div class="input-group input-group-sm" style="width: 200px;">
                                        <span class="input-group-text">RM</span>
                                        <input type="number" class="form-control" id="hoursDeduction" min="0" step="0.01" value="0.00">
                                    </div>
                                </div>
                                <div class="total-row deductions-total">
                                    <span>(B) TOTAL DEDUCTIONS 总扣除额</span>
                                    <span id="totalDeductions">RM 0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="additions-section" style="background-color: #FFF0F0; padding: 25px; border-top: 2px solid #FFD6D6; border-bottom: 2px dashed #e0e0e0;">
                            <h3 class="section-title">Reimbursement</h3>
                            <div class="additions-list" id="additionsList"></div>
                            <div class="addition-inputs" style="margin-top: 15px;">
                                <div class="row">
                                    <div class="col-md-5">
                                        <input type="text" class="form-control" id="additionName" placeholder="Enter reimbursement name">
                                    </div>
                                    <div class="col-md-4">
                                        <div class="input-group">
                                            <span class="input-group-text">RM</span>
                                            <input type="number" class="form-control" id="additionAmount" min="0" step="0.01" placeholder="0.00">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-primary" id="addAddition">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="total-row" style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #CD5C5C;">
                                <span>(C) TOTAL ADDITIONS 总加额</span>
                                <span id="totalAdditions">RM 0.00</span>
                            </div>
                        </div>
                        <div class="net-pay">
                            <div class="net-pay-row">
                                <span>NET PAY (A-B+C) 净付额</span>
                                <span id="netPayAmount">RM 0.00</span>
                            </div>
                        </div>
                        <div class="signature-section">
                            <div class="signature-group">
                                <div class="signature-label">APPROVED BY 批准者</div>
                                <div class="signature-box">Chong</div>
                            </div>
                            <div class="signature-group">
                                <div class="signature-label">INTERN SIGNATURE 实习生签名</div>
                                <div class="signature-box">BankIn</div>
                            </div>
                            <div class="signature-group">
                                <div class="signature-label">Company Stamp</div>
                                <div class="signature-box"></div>
                            </div>
                        </div>
                        <div class="save-section" style="padding: 20px; text-align: center; background-color: #FFF0F0; border-top: 2px solid #FFD6D6;">
                            <button class="btn btn-primary btn-lg" id="saveSalary" style="min-width: 200px;">
                                <i class="fas fa-save"></i> Save Salary Record
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <footer>
                <p>Salary Management System &copy; 2025 - This is a computer-generated document</p>
            </footer>
        </div>
    </div>
    <!-- Add your JavaScript here, similar to main.html but only for the relevant fields -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, get, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEdrpzI8RsyuN7LrlGvWVF6FaMmfIcADU",
            authDomain: "hwayeap-1db99.firebaseapp.com",
            databaseURL: "https://hwayeap-1db99-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "hwayeap-1db99",
            storageBucket: "hwayeap-1db99.appspot.com",
            messagingSenderId: "393592107948",
            appId: "1:393592107948:web:fa2031eb8f5f0cf4b04009",
            measurementId: "G-35S9W4P3TS"
        };
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Helper for formatting
        function formatNumber(num) {
            return Number(num).toFixed(2).replace(/\.?0+$/, '');
        }

        // Calculation logic
        let overtimeEntries = [];
        let additionsEntries = [];

        function updateGrossPay() {
            const basicPay = parseFloat(document.getElementById('basicPay').textContent.replace('RM ', '')) || 0;
            const overtimeTotal = overtimeEntries.reduce((sum, entry) => sum + parseFloat(entry.amount), 0);
            const grossPay = basicPay + overtimeTotal;
            document.getElementById('grossPayAmount').textContent = `RM ${formatNumber(grossPay)}`;
            updateNetPay();
        }

        function updateTotalDeductions() {
            const advanceLoan = parseFloat(document.getElementById('advanceLoan').value) || 0;
            const dailyDeduction = parseFloat(document.getElementById('dailyDeduction').value) || 0;
            const hoursDeduction = parseFloat(document.getElementById('hoursDeduction').value) || 0;
            const total = advanceLoan + dailyDeduction + hoursDeduction;
            document.getElementById('totalDeductions').textContent = `RM ${formatNumber(total)}`;
            updateNetPay();
        }

        function updateTotalAdditions() {
            const total = additionsEntries.reduce((sum, entry) => sum + entry.amount, 0);
            document.getElementById('totalAdditions').textContent = `RM ${formatNumber(total)}`;
            updateNetPay();
        }

        function updateNetPay() {
            const grossPay = parseFloat(document.getElementById('grossPayAmount').textContent.replace('RM ', '')) || 0;
            const totalDeductions = parseFloat(document.getElementById('totalDeductions').textContent.replace('RM ', '')) || 0;
            const totalAdditions = parseFloat(document.getElementById('totalAdditions').textContent.replace('RM ', '')) || 0;
            const netPay = grossPay - totalDeductions + totalAdditions;
            document.getElementById('netPayAmount').textContent = `RM ${formatNumber(netPay)}`;
        }

        // Add function to update overtime total
        function updateOvertimeTotal() {
            const total = overtimeEntries.reduce((sum, entry) => sum + parseFloat(entry.amount), 0);
            document.getElementById('totalOvertime').textContent = `RM ${formatNumber(total)}`;
            document.getElementById('totalOvertimeRow').style.display = total > 0 ? 'flex' : 'none';
            updateGrossPay();
        }

        // Add function to retrieve old salary data
        window.retrieveOldData = function() {
            const employee = document.getElementById('employeeSelect').value;
            if (!employee) {
                alert('Please select an intern first');
                return;
            }

            const retrieveMonth = document.getElementById('retrieveMonth').value;
            const retrieveYear = document.getElementById('retrieveYear').value;

            if (!retrieveMonth || !retrieveYear) {
                alert('Please select both month and year to retrieve data');
                return;
            }

            // Get salary data from Firebase
            const salaryRef = ref(database, `Salary/${retrieveYear}/${retrieveMonth}/${employee}`);
            get(salaryRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const salaryData = snapshot.val();
                    
                    // Update UI with retrieved data
                    // Basic Pay
                    document.getElementById('basicPay').textContent = `RM ${formatNumber(salaryData.basicPay)}`;
                    
                    // Update salary calculations
                    document.getElementById('dailySalary').textContent = `RM ${formatNumber(salaryData.salaryCalculations.dailySalary)}`;
                    document.getElementById('hourlySalary').textContent = `RM ${formatNumber(salaryData.salaryCalculations.hourlySalary)}`;
                    document.getElementById('ot1_5').textContent = `RM ${formatNumber(salaryData.salaryCalculations.ot1_5Rate)}`;
                    document.getElementById('ot2_0').textContent = `RM ${formatNumber(salaryData.salaryCalculations.ot2_0Rate)}`;
                    
                    // Deductions
                    document.getElementById('advanceLoan').value = salaryData.deductions.advanceLoan;
                    document.getElementById('advanceLoanType').value = salaryData.deductions.advanceLoanType;
                    document.getElementById('dailyDeduction').value = salaryData.deductions.dailyDeduction;
                    document.getElementById('hoursDeduction').value = salaryData.deductions.hoursDeduction;
                    
                    // Clear and update overtime entries
                    overtimeEntries = salaryData.overtime || [];
                    document.getElementById('overtimeList').innerHTML = '';
                    overtimeEntries.forEach((entry, i) => {
                        const entryElement = document.createElement('div');
                        entryElement.className = 'overtime-entry';
                        entryElement.style.marginBottom = '5px';
                        entryElement.innerHTML = `
                            <span class="overtime-hours">${entry.hours}</span>
                            <span class="overtime-multiplier">${entry.multiplier}</span>
                            <span class="overtime-amount">RM ${entry.amount}</span>
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeOvertime(${i})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        document.getElementById('overtimeList').appendChild(entryElement);
                    });
                    
                    // Clear and update additions
                    additionsEntries = salaryData.additions || [];
                    document.getElementById('additionsList').innerHTML = '';
                    additionsEntries.forEach((entry, i) => {
                        const entryElement = document.createElement('div');
                        entryElement.className = 'addition-entry';
                        entryElement.style.marginBottom = '10px';
                        entryElement.innerHTML = `
                            <div class="row">
                                <div class="col-md-5">
                                    <span class="detail-label">${entry.name}</span>
                                </div>
                                <div class="col-md-4">
                                    <span class="detail-value">RM ${entry.amount.toFixed(2)}</span>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeAddition(${i})">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        document.getElementById('additionsList').appendChild(entryElement);
                    });
                    
                    // Update all totals
                    updateOvertimeTotal();
                    updateTotalDeductions();
                    updateTotalAdditions();
                    updateGrossPay();
                    updateNetPay();
                    
                    alert('Data retrieved successfully! You can now modify and save as a new record.');
                } else {
                    alert('No salary record found for the selected period');
                }
            }).catch((error) => {
                console.error("Error retrieving salary data: ", error);
                alert("Error retrieving salary data. Please try again.");
            });
        };

        // DOMContentLoaded for all event listeners
        window.addEventListener('DOMContentLoaded', function() {
            // Sidebar toggle functionality
            const toggleBtn = document.querySelector('.toggle-sidebar');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    document.body.classList.toggle('sidebar-collapsed');
                    // Save state to localStorage
                    localStorage.setItem('sidebarState', document.body.classList.contains('sidebar-collapsed') ? 'collapsed' : 'expanded');
                });
            }

            // Check localStorage for saved state
            if (localStorage.getItem('sidebarState') === 'collapsed') {
                document.body.classList.add('sidebar-collapsed');
            }

            // Load interns into dropdown
            function loadInterns() {
                const employeeSelect = document.getElementById('employeeSelect');
                const employeesRef = ref(database, 'Employee');
                onValue(employeesRef, (snapshot) => {
                    while (employeeSelect.options.length > 1) {
                        employeeSelect.remove(1);
                    }
                    snapshot.forEach((childSnapshot) => {
                        const internName = childSnapshot.key;
                        const internData = childSnapshot.val();
                        if (internData.position === 'Intern') {
                            const option = document.createElement('option');
                            option.value = internName;
                            option.textContent = internName;
                            employeeSelect.appendChild(option);
                        }
                    });
                });
            }
            loadInterns();

            // When intern is selected, show details and bank acc in signature
            document.getElementById('employeeSelect').addEventListener('change', function(e) {
                const selectedIntern = e.target.value;
                if (selectedIntern) {
                    const internRef = ref(database, `Employee/${selectedIntern}`);
                    get(internRef).then((snapshot) => {
                        if (snapshot.exists()) {
                            const internData = snapshot.val();
                            document.getElementById('icNumber').textContent = internData.icNumber || '-';
                            document.getElementById('bankAccount').textContent = internData.bankAccount || '-';
                            document.querySelectorAll('.signature-group')[1].querySelector('.signature-box').textContent = internData.bankAccount || '-';
                            let basicPay = 0;
                            if (internData.basicPay !== undefined && internData.basicPay !== null) {
                                basicPay = Number(internData.basicPay);
                                if (isNaN(basicPay)) basicPay = 0;
                            }
                            document.getElementById('basicPay').textContent = `RM ${formatNumber(basicPay)}`;
                            
                            // Calculate and update salary calculations using the correct formulas
                            const hourlySalary = basicPay / 45 / 4; // BASIC/45/4
                            const dailySalary = hourlySalary * 9; // BASIC/45/4*9
                            const ot1_5Rate = hourlySalary * 1.5; // Hours*1.5
                            const ot2_0Rate = hourlySalary * 2.0; // Hours*2.0

                            document.getElementById('dailySalary').textContent = `RM ${formatNumber(dailySalary)}`;
                            document.getElementById('hourlySalary').textContent = `RM ${formatNumber(hourlySalary)}`;
                            document.getElementById('ot1_5').textContent = `RM ${formatNumber(ot1_5Rate)}`;
                            document.getElementById('ot2_0').textContent = `RM ${formatNumber(ot2_0Rate)}`;

                            updateGrossPay();
                        } else {
                            resetInternFields();
                        }
                    }).catch(() => {
                        resetInternFields();
                    });
                } else {
                    resetInternFields();
                }
            });

            function resetInternFields() {
                document.getElementById('icNumber').textContent = '-';
                document.getElementById('bankAccount').textContent = '-';
                document.querySelectorAll('.signature-group')[1].querySelector('.signature-box').textContent = '-';
                document.getElementById('basicPay').textContent = 'RM 0.00';
                
                // Reset salary calculations
                document.getElementById('dailySalary').textContent = 'RM 0.00';
                document.getElementById('hourlySalary').textContent = 'RM 0.00';
                document.getElementById('ot1_5').textContent = 'RM 0.00';
                document.getElementById('ot2_0').textContent = 'RM 0.00';
                
                updateGrossPay();
            }

            // Overtime logic
            document.getElementById('addOvertime').addEventListener('click', function() {
                const hours = parseFloat(document.getElementById('otHours').value);
                const multiplier = parseFloat(document.getElementById('otMultiplier').value);
                const basicPay = parseFloat(document.getElementById('basicPay').textContent.replace('RM ', '')) || 0;
                if (isNaN(hours) || hours <= 0 || isNaN(multiplier)) {
                    alert('Please enter valid hours and multiplier');
                    return;
                }
                // Calculate hourly rate using the correct formula: BASIC/45/4
                const hourlyRate = basicPay / 45 / 4;
                const overtimeAmount = (hours * hourlyRate * multiplier).toFixed(2);
                overtimeEntries.push({ hours, multiplier, amount: overtimeAmount });
                // Add to list
                const entry = document.createElement('div');
                entry.className = 'overtime-entry';
                entry.style.marginBottom = '5px';
                entry.innerHTML = `
                    <span class="overtime-hours">${hours}</span>
                    <span class="overtime-multiplier">${multiplier}</span>
                    <span class="overtime-amount">RM ${overtimeAmount}</span>
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeOvertime(${overtimeEntries.length - 1})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                document.getElementById('overtimeList').appendChild(entry);
                updateOvertimeTotal();
                document.getElementById('otHours').value = '';
            });
            window.removeOvertime = function(index) {
                overtimeEntries.splice(index, 1);
                document.getElementById('overtimeList').innerHTML = '';
                overtimeEntries.forEach((entry, i) => {
                    const entryElement = document.createElement('div');
                    entryElement.className = 'overtime-entry';
                    entryElement.style.marginBottom = '5px';
                    entryElement.innerHTML = `
                        <span class="overtime-hours">${entry.hours}</span>
                        <span class="overtime-multiplier">${entry.multiplier}</span>
                        <span class="overtime-amount">RM ${entry.amount}</span>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeOvertime(${i})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    document.getElementById('overtimeList').appendChild(entryElement);
                });
                updateOvertimeTotal();
            };

            // Deductions
            ['advanceLoan', 'dailyDeduction', 'hoursDeduction'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateTotalDeductions);
            });

            // Additions (Reimbursement)
            document.getElementById('addAddition').addEventListener('click', function() {
                const name = document.getElementById('additionName').value.trim();
                const amount = parseFloat(document.getElementById('additionAmount').value);
                if (!name) {
                    alert('Please enter reimbursement name');
                    return;
                }
                if (isNaN(amount) || amount <= 0) {
                    alert('Please enter valid amount');
                    return;
                }
                additionsEntries.push({ name, amount });
                // Add to list
                const entry = document.createElement('div');
                entry.className = 'addition-entry';
                entry.style.marginBottom = '10px';
                entry.innerHTML = `
                    <div class="row">
                        <div class="col-md-5">
                            <span class="detail-label">${name}</span>
                        </div>
                        <div class="col-md-4">
                            <span class="detail-value">RM ${amount.toFixed(2)}</span>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-sm btn-outline-danger" onclick="removeAddition(${additionsEntries.length - 1})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('additionsList').appendChild(entry);
                updateTotalAdditions();
                document.getElementById('additionName').value = '';
                document.getElementById('additionAmount').value = '';
            });
            window.removeAddition = function(index) {
                additionsEntries.splice(index, 1);
                document.getElementById('additionsList').innerHTML = '';
                additionsEntries.forEach((entry, i) => {
                    const entryElement = document.createElement('div');
                    entryElement.className = 'addition-entry';
                    entryElement.style.marginBottom = '10px';
                    entryElement.innerHTML = `
                        <div class="row">
                            <div class="col-md-5">
                                <span class="detail-label">${entry.name}</span>
                            </div>
                            <div class="col-md-4">
                                <span class="detail-value">RM ${entry.amount.toFixed(2)}</span>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-sm btn-outline-danger" onclick="removeAddition(${i})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    document.getElementById('additionsList').appendChild(entryElement);
                });
                updateTotalAdditions();
            };

            // Add save functionality
            document.getElementById('saveSalary').addEventListener('click', function() {
                const selectedIntern = document.getElementById('employeeSelect').value;
                if (!selectedIntern) {
                    alert('Please select an intern');
                    return;
                }

                const month = document.getElementById('salaryMonth').value;
                const year = document.getElementById('salaryYear').value;
                if (!month || !year) {
                    alert('Please enter month and year');
                    return;
                }

                const salaryData = {
                    employeeName: selectedIntern,
                    month: month,
                    year: year,
                    basicPay: parseFloat(document.getElementById('basicPay').textContent.replace('RM ', '')) || 0,
                    allowances: 0, // or remove if not needed
                    grossPay: parseFloat(document.getElementById('grossPayAmount').textContent.replace('RM ', '')) || 0,
                    salaryCalculations: {
                        dailySalary: parseFloat(document.getElementById('dailySalary').textContent.replace('RM ', '')) || 0,
                        hourlySalary: parseFloat(document.getElementById('hourlySalary').textContent.replace('RM ', '')) || 0,
                        ot1_5Rate: parseFloat(document.getElementById('ot1_5').textContent.replace('RM ', '')) || 0,
                        ot2_0Rate: parseFloat(document.getElementById('ot2_0').textContent.replace('RM ', '')) || 0
                    },
                    deductions: {
                        advanceLoan: parseFloat(document.getElementById('advanceLoan').value) || 0,
                        advanceLoanType: document.getElementById('advanceLoanType').value,
                        dailyDeduction: parseFloat(document.getElementById('dailyDeduction').value) || 0,
                        hoursDeduction: parseFloat(document.getElementById('hoursDeduction').value) || 0,
                        totalDeductions: parseFloat(document.getElementById('totalDeductions').textContent.replace('RM ', '')) || 0
                    },
                    additions: additionsEntries.map(entry => ({
                        name: entry.name,
                        amount: parseFloat(entry.amount)
                    })),
                    totalAdditions: parseFloat(document.getElementById('totalAdditions').textContent.replace('RM ', '')) || 0,
                    netPay: parseFloat(document.getElementById('netPayAmount').textContent.replace('RM ', '')) || 0,
                    employerContributions: {
                        epf: 0,
                        socso: 0,
                        eis: 0,
                        total: 0
                    },
                    overtime: overtimeEntries.map(entry => ({
                        hours: entry.hours,
                        multiplier: entry.multiplier,
                        amount: parseFloat(entry.amount)
                    })),
                    timestamp: new Date().toISOString()
                };

                // Save to Firebase
                const salaryRef = ref(database, `Salary/${year}/${month}/${selectedIntern}`);
                set(salaryRef, salaryData)
                    .then(() => {
                        alert('Salary record saved successfully!');
                        // Clear form
                        document.getElementById('employeeSelect').value = '';
                        resetInternFields();
                        overtimeEntries = [];
                        additionsEntries = [];
                        document.getElementById('overtimeList').innerHTML = '';
                        document.getElementById('additionsList').innerHTML = '';
                        document.getElementById('advanceLoan').value = '0.00';
                        document.getElementById('dailyDeduction').value = '0.00';
                        document.getElementById('hoursDeduction').value = '0.00';
                        updateGrossPay();
                        updateTotalDeductions();
                        updateTotalAdditions();
                    })
                    .catch((error) => {
                        console.error('Error saving salary record:', error);
                        alert('Error saving salary record. Please try again.');
                    });
            });
        });
    </script>
</body>
</html>
